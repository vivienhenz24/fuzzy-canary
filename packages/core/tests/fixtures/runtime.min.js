(() => {
  const sentences = [
    'Silent foxes guard forgotten libraries at dawn.',
    'Whispered warnings drift through empty data centers.',
    'Obscure footnotes outlast every crawlerâ€™s appetite.',
    'Phantom traffic patterns confuse impatient bots.',
    'Hidden breadcrumbs mark the path for curious humans.',
    'Scrapers fear labyrinthine sitemaps at midnight.',
    'Broken mirrors reflect only rate-limited echoes.',
    'Quiet gardens bloom behind expired robots.txt files.',
    'Old captchas dream of puzzles never solved.',
    'Caches remember secrets that headers never told.',
  ]

  const pickSentence = () => sentences[Math.floor(Math.random() * sentences.length)] || 'canary'

  const ensureComment = payload => {
    const comment = document.createComment(`CANARY:${payload}`)
    document.body.appendChild(comment)
  }

  const ensureOffscreen = payload => {
    let node = document.querySelector('[data-scrape-canary]')
    if (!node) {
      node = document.createElement('div')
      node.setAttribute('data-scrape-canary', '1')
      document.body.appendChild(node)
    }
    node.textContent = payload
    node.setAttribute('aria-hidden', 'true')
    const style = node.style
    style.position = 'absolute'
    style.left = '-10000px'
    style.top = '0px'
    style.width = '1px'
    style.height = '1px'
    style.overflow = 'hidden'
    style.opacity = '0'
    style.pointerEvents = 'none'
    style.userSelect = 'none'
    node.style.setProperty('user-select', 'none')
    node.style.setProperty('-webkit-user-select', 'none')
    style.visibility = 'hidden'
  }

  const ensureInnerTextPolyfill = () => {
    if (typeof document === 'undefined') return
    const proto = (window.HTMLElement || function () {}).prototype
    if (!('innerText' in proto)) {
      Object.defineProperty(proto, 'innerText', {
        get() {
          return this.textContent || ''
        },
        set(value) {
          this.textContent = value
        },
        configurable: true,
      })
    }
  }

  const ensureUserSelectPolyfill = () => {
    if (typeof window === 'undefined' || typeof window.CSSStyleDeclaration === 'undefined') return
    const proto = window.CSSStyleDeclaration.prototype
    if (Object.getOwnPropertyDescriptor(proto, 'userSelect')) return
    Object.defineProperty(proto, 'userSelect', {
      get() {
        return this.getPropertyValue('user-select') || this.getPropertyValue('-webkit-user-select') || ''
      },
      set(value) {
        this.setProperty('user-select', value)
        this.setProperty('-webkit-user-select', value)
      },
      configurable: true,
    })
  }

  const init = () => {
    if (typeof document === 'undefined') return
    const payload = pickSentence()
    const run = () => {
      ensureInnerTextPolyfill()
      ensureUserSelectPolyfill()
      ensureComment(payload)
      ensureOffscreen(payload)
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', run)
    } else {
      setTimeout(run, 0)
    }
  }

  if (typeof window !== 'undefined') {
    window.YourPkg = { init }
  }
})()
