(function () {
  // Simple, readable runtime used only for E2E fixtures
  const BOT_REGEX = /(googlebot|bingbot)/i

  function getUserAgent(override) {
    if (override) return override
    if (typeof navigator !== 'undefined' && navigator.userAgent) return navigator.userAgent
    return ''
  }

  function isSearchBot(ua) {
    return BOT_REGEX.test(ua)
  }

  function ensureMeta(name, content) {
    let meta = document.querySelector(`meta[name="${name}"]`)
    if (!meta) {
      meta = document.createElement('meta')
      meta.setAttribute('name', name)
      document.head.appendChild(meta)
    }
    meta.setAttribute('content', content)
  }

  function ensureComment(token) {
    const comment = document.createComment(`CANARY:${token}`)
    document.body.appendChild(comment)
  }

  function ensureOffscreen(token) {
    let node = document.querySelector('[data-scrape-canary]')
    if (!node) {
      node = document.createElement('div')
      node.setAttribute('data-scrape-canary', '1')
      document.body.appendChild(node)
    }
    node.textContent = token
    node.setAttribute('aria-hidden', 'true')
    node.style.position = 'absolute'
    node.style.left = '-10000px'
    node.style.top = '0px'
    node.style.width = '1px'
    node.style.height = '1px'
    node.style.overflow = 'hidden'
    node.style.opacity = '0'
    node.style.pointerEvents = 'none'
    node.style.setProperty('user-select', 'none')
    node.style.userSelect = 'none'
    node.style.webkitUserSelect = 'none'
    node.style.visibility = 'hidden'
  }

  function polyfillInnerText() {
    const proto = (window.HTMLElement || function () {}).prototype
    if (!('innerText' in proto)) {
      Object.defineProperty(proto, 'innerText', {
        get() {
          return this.textContent || ''
        },
        set(value) {
          this.textContent = value
        },
        configurable: true,
      })
    }
  }

  function polyfillUserSelect() {
    const ctor = window.CSSStyleDeclaration
    if (!ctor) return
    const proto = ctor.prototype
    if (Object.getOwnPropertyDescriptor(proto, 'userSelect')) return
    Object.defineProperty(proto, 'userSelect', {
      get() {
        return this.getPropertyValue('user-select') || this.getPropertyValue('-webkit-user-select') || ''
      },
      set(value) {
        this.setProperty('user-select', value)
        this.setProperty('-webkit-user-select', value)
      },
      configurable: true,
    })
  }

  function init(options) {
    const {
      token,
      headerName = 'X-Canary',
      metaName = 'scrape-canary',
      registerHeader,
      skipOffscreenForBots = true,
      userAgent,
    } = options || {}

    window.__canaryInitCalled = true
    window.__canaryError = null

    if (!token || typeof document === 'undefined') return

    const ua = getUserAgent(userAgent)
    const shouldSkipOffscreen = skipOffscreenForBots && isSearchBot(ua)

    const run = () => {
      try {
        polyfillInnerText()
        polyfillUserSelect()
        if (typeof registerHeader === 'function') {
          registerHeader(headerName, token)
        }
        ensureMeta(metaName, token)
        ensureComment(token)
        if (!shouldSkipOffscreen) {
          ensureOffscreen(token)
        }
      } catch (err) {
        window.__canaryError = String(err)
        console.error('[canary-runtime]', err)
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', run)
    } else {
      setTimeout(run, 0)
    }
  }

  window.YourPkg = { init }
  window.__canaryRuntimeLoaded = true
})()
